# VanessaExt - библиотека внешних компонент 1С

Библиотека внешних компонент разработана как составная часть инструмента тестирования прикладных решений 
[**Vanessa Automation**](https://github.com/Pr-Mex/vanessa-automation/), хотя имеет 
самостоятельную ценность и может быть использована в составе других продуктов.

Предназначена для Windows и Linux, разработана по технологии Native API.

[![Build status](https://ci.appveyor.com/api/projects/status/jau22n1d2a6bvwpo?svg=true)](https://ci.appveyor.com/project/lintest/vanessaext)

### Возможности бибоиотеки:
- Получение списка окон и списка процессов
- Управление размерами и положением окна
- Получение снимка окна и снимка экрана
- Обмен данными по протоколу WebSocket
- Эмуляция действий пользователя
- Доступ к данным буфера обмена
- Базовая поддержка GIT

### Состав библиотеки

- <a href="Docs/WindowsControl.md">WindowsControl</a>
- <a href="Docs/ProcessControl.md">ProcessControl</a>
- <a href="Docs/ClipboardControl.md">ClipboardControl</a>
- <a href="Docs/GetFor1C.md">GetFor1C</a>

<a href="Docs/BuildLibrary.md">Инструкция по самостоятельной сборке библиотеки</a>

### Общая информация

Внешние компоненты в составе библиотеки поддерживают как синхронный, так и асинхронный вызов.
Для асинхронного вызова в полном соответствии с документацией Синтакс-помощника
1С:Предприятие применяются методы:
- НачатьВызов<ИмяМетода>(<ОписаниеОповещения>, <Параметры>)
- НачатьПолучение<ИмяСвойства>(<ОписаниеОповещения>)

Пример асинхронного вызова внешней компоненты:
```bsl
&НаКлиенте
Процедура ПодключениеВнешнейКомпонентыЗавершение(Подключение, ДополнительныеПараметры) Экспорт
	ОписаниеОповещения = Новый ОписаниеОповещения("ПолученаВерсияКомпоненты", ЭтотОбъект);
	ВнешняяКомпонента.НачатьПолучениеВерсия(ОписаниеОповещения);
КонецПроцедуры

&НаКлиенте
Процедура ПолученаВерсияКомпоненты(Значение, ДополнительныеПараметры) Экспорт
	Заголовок = "Управление окнами, версия " + Значение;
КонецПроцедуры	
```

Все примеры будут приводиться для синхронных вызовов. В публикуемом примере
[**VanessaExt.epf**](https://github.com/lintest/VanessaExt/releases) используются только асинхронные вызовы.

Многие свойства и методы компоненты возвращают сложные типы данных, которые сериализованы 
в строку формата JSON. Поэтому имеет смысл объявить в вызывающем модуле универсальную 
функцию, которая будет использоваться ниже в примерах работы компоненты:
```bsl
Функция ПрочитатьСтрокуJSON(ТекстJSON)
	Если ПустаяСтрока(ТекстJSON) Тогда
		Возврат Неопределено;
	Иначе
		ПоляДаты = Новый Массив;
		ПоляДаты.Добавить("date");
		ПоляДаты.Добавить("CreationDate");
		ЧтениеJSON = Новый ЧтениеJSON();
		ЧтениеJSON.УстановитьСтроку(ТекстJSON);
		Возврат ПрочитатьJSON(ЧтениеJSON, , ПоляДаты);
	КонецЕсли;
КонецФункции
```

## Установка и подключение

В прилагаемом примере файлы внешней компоненты хранятся в макете **VanessaExt**, реквизит формы 
**МестоположениеКомпоненты** используется для передачи макета компоненты между сервером и клиентом.
Для установки и подключения внешней компоненты рекомендуется использовать следующий программный код:

```bsl
&НаКлиенте
Перем ИдентификаторКомпоненты, ВнешняяКомпонента;

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	МакетКомпоненты = РеквизитФормыВЗначение("Объект").ПолучитьМакет("VanessaExt");
	МестоположениеКомпоненты = ПоместитьВоВременноеХранилище(МакетКомпоненты, УникальныйИдентификатор);
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	ИдентификаторКомпоненты = "_" + СтрЗаменить(Новый УникальныйИдентификатор, "-", "");
	ВыполнитьПодключениеВнешнейКомпоненты(Истина);
КонецПроцедуры

&НаКлиенте
Процедура ВыполнитьПодключениеВнешнейКомпоненты(ДополнительныеПараметры) Экспорт
	ОписаниеОповещения = Новый ОписаниеОповещения("ПодключениеВнешнейКомпонентыЗавершение", ЭтаФорма, ДополнительныеПараметры);
	НачатьПодключениеВнешнейКомпоненты(ОписаниеОповещения, МестоположениеКомпоненты, ИдентификаторКомпоненты, ТипВнешнейКомпоненты.Native); 
КонецПроцедуры	

&НаКлиенте
Процедура ПодключениеВнешнейКомпонентыЗавершение(Подключение, ДополнительныеПараметры) Экспорт
	Если Подключение Тогда
		ВнешняяКомпонента = Новый("AddIn." + ИдентификаторКомпоненты + ".WindowsControl");
	ИначеЕсли ДополнительныеПараметры = Истина Тогда
		ОписаниеОповещения = Новый ОписаниеОповещения("ВыполнитьПодключениеВнешнейКомпоненты", ЭтаФорма, Ложь);
		НачатьУстановкуВнешнейКомпоненты(ОписаниеОповещения, МестоположениеКомпоненты);
	КонецЕсли;
КонецПроцедуры	
```

***

При разработке использовались библиотеки:
- [cpp-c11-make-screenshot by Roman Shuvalov](https://github.com/Butataki/cpp-x11-make-screenshot)
- [Clip Library by David Capello](https://github.com/dacap/clip)
- [Boost C++ Libraries](https://www.boost.org/)
